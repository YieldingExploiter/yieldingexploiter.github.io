const cv = require("image-convert")
const fs = require('fs')
const path = require('path')
const loop = (v)=>{
  v=path.resolve(v)
  fs.readdirSync(v).forEach(x=>{
    x=path.join(v,x)
    if (fs.statSync(x).isDirectory()) loop(x)
    else {
      const dt = fs.readFileSync(x)
      let l = x.split('.').reverse();
      l[0]='optimized'
      l=l.reverse().join('.');
      const v=d=>
        imgConvert.fromBuffer(d, (err, response, file) => {
          if (!err) {
            fs.writeFileSync(`${l}${d.quality?'.quality-'+d.quality:''}.${d.size?'.size-'+d.size:''}.${d.output_format}`)
          }
        });
      v({
        buffer: dt,
        quality: 95,
        output_format: "jpg",
        size: "original"
      })
      v({
        buffer: dt,
        quality: 95,
        output_format: "jpg",
        size: 0.5
      })
      v({
        buffer: dt,
        quality: 75,
        output_format: "jpg",
        size: "original"
      })
      v({
        buffer: dt,
        quality: 75,
        output_format: "jpg",
        size: 0.5
      })
      v({
        buffer: dt,
        output_format: "png",
        size: "original"
      })
      v({
        buffer: dt,
        output_format: "png",
        size: 0.5
      })
    }
  })
}
loop('./')
